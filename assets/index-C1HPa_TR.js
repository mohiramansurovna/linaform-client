import{e as x,d as N,R as v,j as e,L as y,r as l,q as m}from"./index-Coke0nAI.js";import{u as k,H as S}from"./sidebar-BzK-oMkL.js";import{I as C}from"./schemas-DHehp46N.js";import{u as h}from"./useMutation-CCGNJDG7.js";import{u as d}from"./useAuthStore-C2RerLba.js";import{D as L,a as P,b as T,c as F,e as q}from"./dialog-ClRiNiXy.js";import{B as j}from"./createLucideIcon-CNxtfhBc.js";import{H as A}from"./heart-CfY2rRIA.js";import{u as z}from"./useUserStore-D65FoZI4.js";import{E as K}from"./eye-CSVZejQ-.js";import{u as E,r as I,g as $,S as D,H as Q,P as B,T as M,a as H,F as U,b as O,C as R,B as V,I as G,M as W}from"./index-Dk265Ort.js";import{u as _}from"./useThemeStore-C9wODLBM.js";import{a as J,L as Y}from"./loading-DJIteJ_R.js";import{P as X}from"./post-Doj8FOzJ.js";import"./useBaseQuery-CQeARSMF.js";import"./index-DzwLIVv3.js";import"./react-qWK4YXkQ.js";import"./loader-D4D9C3O7.js";const Z="https://linaform-server.onrender.com",f=()=>{const{id:t}=x();return k({queryKey:["post"],queryFn:async()=>{const s=await fetch(Z+"/api/post/"+t);if(!s.ok)throw new Error("Failed to fetch post");return await s.json()}})},g="https://linaform-server.onrender.com",ee=()=>{const t=N(),{accessToken:s}=d(),{id:n}=x();return h({mutationKey:["postComment",n],mutationFn:async r=>await fetch(g+`/api/post/${n}/comment`,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({content:r})}).then(async i=>{if(!i.ok)throw new Error((await i.json()).error||"Failed to post comment");return!0}),onSuccess:async()=>await t.invalidateQueries({queryKey:["post"]}).then(()=>!0).catch(r=>(console.log(r),!1))})},te=()=>{const{id:t}=x();return h({mutationKey:["postView",t],mutationFn:async()=>await fetch(g+`/api/post/${t}/view`,{method:"POST"}).then(async s=>{s.ok||console.log(s.status)})})},se=()=>{const{id:t}=x(),{accessToken:s}=d();return h({mutationKey:["postLike",t],mutationFn:async()=>await fetch(g+`/api/post/${t}/like`,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}).then(async n=>{if(!n.ok)throw new Error("Failed to like");return n.json()})})},ne=()=>{const{accessToken:t}=d();return h({mutationKey:["postUnlike"],mutationFn:async s=>await fetch(g+`/api/post/${s}/unlike`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}).then(async n=>{n.ok||console.log(n.status)})})};function re({open:t,onOpenChange:s}){return e.jsx(L,{open:t,onOpenChange:s,children:e.jsxs(P,{className:"sm:max-w-md bg-white dark:bg-zinc-900",children:[e.jsx(T,{children:e.jsx(F,{className:"text-lg font-semibold text-center text-zinc-900 dark:text-zinc-100",children:"Sign in required"})}),e.jsx("p",{className:"text-center text-sm text-zinc-600 dark:text-zinc-400 mb-4",children:"You need to sign in to like, subscribe, or post a comment."}),e.jsx("img",{src:"/linaform-client/auth-dialog.svg",alt:"Sign in required",className:"mx-auto w-1/2"}),e.jsxs(q,{children:[e.jsx(y,{to:"/login",className:"w-full",children:e.jsx(j,{variant:"default",className:"w-full",children:"Sign In"})}),e.jsx(y,{to:"/register",className:"w-full",children:e.jsx(j,{variant:"outline",className:"w-full",children:"Register"})})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(j,{variant:"ghost",className:"text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-300",onClick:()=>s(!1),children:"Continue Without Account"})})]})})}const b=v.memo(re);function ie({likes:t,postId:s}){const{user:n}=d(),[r,i]=l.useState(!1),c=se(),a=ne(),p=t.find(o=>o.userId===n?.id),w=async()=>{if(!n){i(!0);return}if(p)m.setQueryData(["post"],o=>o.likes?{...o,likes:o.likes.filter(u=>u.id!==p.id)}:o),a.mutate(p.id,{onSuccess:()=>{m.invalidateQueries({queryKey:["postUnlike"]})},onError:()=>{m.invalidateQueries({queryKey:["postUnlike"]})}});else{const o={id:"temp-id",userId:n.id,noteId:s};c.mutate(void 0,{onSuccess:()=>{m.invalidateQueries({queryKey:["postLike"]}),m.setQueryData(["post"],u=>u.likes?{...u,likes:[...u.likes,o]}:u)},onError:()=>{m.invalidateQueries({queryKey:["postLike"]})}})}};return e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"mt-4 flex items-center gap-1 text-sm text-zinc-600 dark:text-zinc-300",onClick:w,children:[e.jsx(A,{className:`${p&&"fill-red-600"} text-red-600`,size:20}),t.length]}),e.jsx(b,{open:r,onOpenChange:i})]})}function ae(){const{data:t}=f(),{setSelectedUserId:s}=z(),n=te();return l.useEffect(()=>{const r=setTimeout(()=>{n.mutate()},1e4);return()=>clearTimeout(r)},[]),t?e.jsx("header",{className:"max-w-3xl mx-auto py-6 border-b border-zinc-200 dark:border-zinc-700 flex justify-between items-start",children:e.jsxs("div",{className:"w-full",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2 text-zinc-900 dark:text-zinc-100",children:t.title}),e.jsxs("div",{className:"flex items-center gap-2 text-zinc-600 dark:text-zinc-400 text-sm",children:[e.jsx("button",{onClick:()=>s(t.user.id),className:"font-medium cursor-pointer",children:t.user.username}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:new Date(t.publishedAt).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})})]}),t.description&&e.jsx("p",{className:"mt-4 text-zinc-700 dark:text-zinc-300 w-full line-clamp-3",children:t.description}),e.jsxs("div",{className:"flex items-center w-full justify-end gap-4",children:[e.jsxs("span",{className:"mt-4 flex items-center gap-1 text-sm text-zinc-600 dark:text-zinc-300",children:[e.jsx(K,{size:20})," ",t.views]}),e.jsx(ie,{likes:t.likes,postId:t.id})]})]})}):null}function oe(){const{data:t,error:s,isLoading:n}=f(),{syncFonts:r}=E(),{theme:i}=_();l.useEffect(()=>{t&&r(t.content)},[r,t]);const c=l.useMemo(()=>{if(!(!t||!t.content))return I(t.content,i=="dark")},[t,i]);if(t&&c){const a=$(c,[D,Q,B.configure({placeholder:"Start typing..."}),M.configure({types:["heading","paragraph"]}),H,U,O,R,V,G,W]);return e.jsx(J,{isLoading:n,children:e.jsx("main",{className:"prose prose-gray dark:prose-invert max-w-3xl mx-auto py-6 px-4 sm:px-0",dangerouslySetInnerHTML:{__html:a}})})}else return s?e.jsx("div",{children:s.message}):null}const ce="https://linaform-server.onrender.com";function le(){const{id:t}=x();return k({queryKey:["similar-posts",t],queryFn:async()=>(await fetch(ce+`/api/post/${t}/similar`)).json(),enabled:!!t})}function ue(){const{data:t}=f(),{data:s,isLoading:n}=le();return t?e.jsxs("footer",{className:"max-w-3xl mx-auto py-8 border-t border-zinc-200 dark:border-zinc-700 mt-8",children:[e.jsxs("h1",{className:"text-lg font-semibold text-zinc-900 dark:text-zinc-100",children:["Read more from ",t.user.username]}),e.jsx("h2",{className:"text-zinc-500 dark:text-zinc-400 text-sm",children:"Similar articles"}),n&&e.jsx("div",{className:"mt-2 text-sm text-zinc-500",children:"Loading..."}),s&&s.length>0&&e.jsx(X,{containerClassName:"mt-6 flex flex-col gap-6",posts:s})]}):null}function me(){const t=l.useRef(null),{isAuthenticated:s}=d(),[n,r]=l.useState(!1),i=ee(),c=()=>{if(!t.current)return;const a=t.current.value.trim();if(a){if(t.current.value="",!s){r(!0);return}i.mutate(a)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mt-4",children:[e.jsx(C,{ref:t,placeholder:"Write a comment...",className:"flex-1",onKeyDown:a=>{a.key==="Enter"&&(a.preventDefault(),c())}}),e.jsx(Y,{disabled:i.isPending,onClick:c,children:"Post"})]}),e.jsx(b,{open:n,onOpenChange:r})]})}function de(){const{data:t}=f(),{setSelectedUserId:s}=z(),n=l.useCallback(r=>new Date(r).toLocaleString(void 0,{hour:"numeric",minute:"numeric",day:"numeric",month:"short"}),[]);return!t||!t.comments?null:e.jsxs("section",{className:"max-w-3xl mx-auto py-8 border-t border-zinc-200 dark:border-zinc-700 mt-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-zinc-900 dark:text-zinc-100",children:"Comments"}),e.jsx("div",{className:"space-y-4",children:t.comments.map(r=>e.jsxs("div",{className:"p-4 border border-zinc-200 dark:border-zinc-700 rounded-lg bg-zinc-50 dark:bg-zinc-800",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("button",{onClick:()=>s(r.user.id),className:"font-medium text-zinc-900 dark:text-zinc-100",children:r.user.username}),e.jsx("span",{className:"text-sm text-zinc-500 dark:text-zinc-400",children:n(r.createdAt)})]}),e.jsx("p",{className:"text-zinc-700 dark:text-zinc-300",children:r.content})]},r.id))}),e.jsx(me,{})]})}function Fe(){const{isAuthenticated:t}=d();return e.jsxs("div",{className:"min-h-screen",children:[t&&e.jsx(S,{className:"fixed"}),e.jsx(ae,{}),e.jsx(oe,{}),e.jsx(ue,{}),e.jsx(de,{})]})}export{Fe as default};
